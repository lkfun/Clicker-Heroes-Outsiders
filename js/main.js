// Polyfill for Internet Explorer
Math.log10 = function(x) {
    return Math.log(x) / Math.LN10;
}

let borbToZone = [];
borbToZone[184] = null;
borbToZone = borbToZone.concat([966409,979782,979782,984260,984260,984260,988749,988749,988749,988749,993248,993248,993248,993248,993248,993248,993248,993248,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1021386,1309598,1309598,1309598,1309598,1309598,1309598,1325760,1325760,1340689,1340689,1340689,1340689,1340689,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,1367215,2115108,2115108,2115108,2134603,2134603,2134603,2134603,2134603,2162796,2180849,2180849,2180849,2180849,2180849,2180849,2180849,2197526,2197526,2197526,2197526,2197526,2212929,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2227158,2429081,2459157,2459157,2459157,2459157,2459157,2459157,2459157,2459157,2459157,2486938,2486938,2486938,2486938,2486938,2486938,2486938,2486938,2547841,2547841,2547841,2547841,2547841,2547841,2547841,2547841,2547841,2580393,2580393,2580393,2580393,2580393,2580393,2610461,2610461,2610461,2610461,2610461,2610461,2610461,2638235,2638235,2638235,2638235,2638235,2638235,2638235,2638235,2638235,2638235,2638235,2663889,2663889,2663889,2663889,2663889,2663889,2663889,2663889,2663889,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2741250,2822756,2822756,2822756,2822756,2822756,2867255,2867255,2867255,2867255,2867255,2886991,2886991,2886991,2886991,2886991,2886991,2886991,2886991,2886991,2886991,2886991,2886991,2886991,2984324,2984324,2984324,2984324,2984324,2984324,2984324,2984324,2984324,3067321,3067321,3067321,3067321,3067321,3115671,3115671,3115671,3115671,3115671,3115671,3115671,3115671,3115671,3115671,3115671,3115671,3115671,3160331,3160331,3201583,3201583,3201583,3201583,3201583,3201583,3201583,3201583,3201583,3201583,3239688,3239688,3239688,3239688,3239688,3239688,3239688,3239688,3239688,3274884,3274884,3274884,3274884,3274884,3274884,3274884,3307395,3307395,3307395,3307395,3307395,3307395,3307395,3307395,3307395,3348983,3348983,3348983,3348983,3348983,3348983,3348983,3348983,3348983,3348983,3348983,3348983,3387398,3387398,3387398,3387398,3387398,3387398,3455657,3455657,3455657,3455657,3455657,3455657,3455657,3455657,3497480,3497480,3497480,3497480,3497480,3497480,3497480,3497480,3497480,3497480,3497480,3556905,3556905,3556905,3556905,3556905,3556905,3556905,3556905,3556905,3556905,3556905,3611794,3611794,3611794,3611794,3611794,3611794,3611794,3611794,3611794,3611794,3611794,3611794,3662496,3662496,3662496,3662496,3662496,3662496,3662496,3662496,3662496,3662496,3662496,3662496,3662496,3662496,3720867,3720867,3720867,3720867,3720867,3720867,3720867,3720867,3720867,3720867,3720867,3720867,3720867,3720867,3774784,3774784,3774784,3774784,3774784,3774784,3824586,3824586,3824586,3824586,3824586,3824586,3824586,3824586,3824586,3870588,3870588,3870588,3870588,3870588,3870588,3870588,3870588,3870588,3870588,3870588,3870588,3924638,3924638,3924638,3924638,3974563,4020679,4020679,4020679,4020679,4020679,4020679,4020679,4020679,4020679,4020679,4020679,4020679,4063275,4063275,4102621,4102621,4102621,4102621,4102621,4102621,4102621,4102621,4102621,4102621,4102621,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4171306,4234750,4234750,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4304891,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4369680,4429524,4429524,4429524,4429524,4429524,4429524,4429524,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4496360,4558096,4558096,4667794,4667794,4667794,4667794,4667794,4667794,4667794,4667794,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4727997,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4834971,4882417,4882417,4882417,4882417,4882417,4882417,4882417,4926243,4926243,4926243,4926243,4926243,4926243,4926243,4926243,4926243,4926243,4926243,5070557,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5100026,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5152389,5175613,5175613,5175613,5175613,5319130,5319130,5329630,5329630,5339329,5339329,5339329,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5348289,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205,5452205]);

function decimalAdjust(type, value, exp) {
    // If the exp is undefined or zero...
    if (typeof exp === 'undefined' || +exp === 0) {
        return Math[type](value);
    }
    value = +value;
    exp = +exp;
    // If the value is not a number or the exp is not an integer...
    if (value === null || isNaN(value) || !(typeof exp === 'number' && exp % 1 === 0)) {
        return NaN;
    }
    // Shift
    value = value.toString().split('e');
    value = Math[type](+(value[0] + 'e' + (value[1] ? (+value[1] - exp) : -exp)));
    // Shift back
    value = value.toString().split('e');
    return +(value[0] + 'e' + (value[1] ? (+value[1] + exp) : exp));
}

Math.round10 = function(value, exp) {
    return decimalAdjust('round', value, exp);
}

var settingsVisible = false;

function showSettingsClick() {
    $("#settings").toggle(100, function(){
        $("#showSettings").html( (settingsVisible = !settingsVisible) ? "隐藏设置" : "打开设置");
    });
}

function setDefaults() {
    $("#zoneOverride").val(0);
}

function defaultClick() {
    setDefaults();
}

function getCostFromLevel(level) {
    return (level+1)*(level/2);
}

function spendAS( ratio, as ) {
    var spendable = ratio*as;
    if( spendable<1 ) return 0;
    return Math.floor( Math.pow( 8*spendable + 1, 0.5 )/2 - 0.5 );
}

function nOS( ancientSouls, transcendentPower, zone ) {
    if(ancientSouls > 20000) {
        ancientSouls -= 11325;
        let pony = spendAS(0.88, ancientSouls);
        ancientSouls -= getCostFromLevel(pony);
        return [150, ancientSouls, pony];
    }
    let hpMultiplier = Math.min(1.545, 1.145 + zone / 500000);
    let hsMultiplier = Math.pow(1 + transcendentPower, 0.2);
    let heroDamageMultiplier = (zone > 1.2e6) ? 1000 : ((zone > 168000) ? 4.5 : 4);
    let heroCostMultiplier = (zone > 1.2e6) ? 1.22 : 1.07;
    let goldToDps = Math.log10(heroDamageMultiplier) / Math.log10(heroCostMultiplier) / 25;
    let dpsToZones = Math.log10(hpMultiplier) - Math.log10(1.15) * goldToDps;
    let chor = 0;
    let phan = 0;
    let pony = 0;

    let chorBuff = 1 / 0.95;

    while (ancientSouls > 0) {
        if (pony < 1) {
            ancientSouls -= ++pony;
            continue;
        } else if (phan < 3) {
            phan++;
            ancientSouls--;
            continue;
        }

        let damageIncrease = (phan + 2) / (phan + 1);
        let zoneIncrease = Math.log10(damageIncrease) / dpsToZones;
        let phanBuff = Math.pow(hsMultiplier, zoneIncrease);

        // Boost Phandoryss for FANT
        if (phan < 50) {
            phanBuff *= Math.pow(1.1, 1 / phan);
        }

        if (chor < ancientSouls && chor < 150) {
            let chorBpAS = Math.pow(chorBuff, 1 / (chor + 1));
            if (chorBpAS >= phanBuff) {
                if (pony < ancientSouls) {
                    let ponyBuff = (Math.pow(pony + 1, 2) * 10 + 1) / (Math.pow(pony, 2) * 10 + 1);
                    let ponyBpAS = Math.pow(ponyBuff, 1 / (pony + 1));
                    if (ponyBpAS >= chorBpAS) {
                        ancientSouls -= ++pony;
                        continue;
                    }
                }
                ancientSouls -= ++chor;
                continue;
            }
        }

        if (pony < ancientSouls) {
            let ponyBuff = (Math.pow(pony + 1, 2) * 10 + 1) / (Math.pow(pony, 2) * 10 + 1);
            let ponyBpAS = Math.pow(ponyBuff, 1 / (pony + 1));
            if (ponyBpAS >= phanBuff) {
                ancientSouls -= ++pony;
                continue;
            }
        }

        phan++;
        ancientSouls--;

    }

    return [chor, phan, pony];
}//function nOS

function getBorbFant( ancientSouls, transcendentPower ) {
    let IEsucks = nOS( ancientSouls * 0.5, transcendentPower, 100 );
    let chor = IEsucks[0];
    let phan = IEsucks[1];
    let pony = IEsucks[2];
    let ponyBonus = Math.pow(pony, 2) * 10 + 1;
    let chorBonus = Math.pow(1 / 0.95, chor);
    let tp = 1 + transcendentPower;
    let s = tp * tp;
    let a = s + s * s + s * s * s;
    let HSFant = 20 * ponyBonus * a;
    let logHSFant = Math.log10(Math.max(1, HSFant));
    logHSFant += Math.log10(chorBonus);
    let kumaFant = Math.max(1, Math.floor(logHSFant / Math.log10(2) - 3 / Math.log(2)) - 1);
    let kumaEffect = 8 * (1 - Math.exp(-0.025 * kumaFant));
    let borbRequired = Math.ceil((8 / kumaEffect - 1) * 8);
    return borbRequired;
}

function getInputs() {
    $("#ancient_souls").val($("#ancient_souls").val().replace(/,/g, ''));
    var ancientSouls = parseFloat( $("#ancient_souls").val() || 0 );
    if( !(ancientSouls>=0) ) {
        alert("计算失败。 远古之魂必须是一个非负数。");
        return -1;
    }
    $("#ancient_souls").val(Math.floor(ancientSouls));
    var val = $( "#zoneOverride" ).val();
        zoneOverride = ( val=="" ) ? 0 : parseFloat( val );
    if( isNaN(zoneOverride) || zoneOverride<0 ) {
        setDefaults();
        zoneOverride = 0;
        alert("高级设置被设置为默认值。");
    }

    return [Math.floor(ancientSouls), zoneOverride];
}

function refresh(test, ancientSouls, simulating) {
    //IE sucks
    if (test === undefined || test === null) test = false;
    if (simulating === undefined || simulating === null) simulating = false;
    if (ancientSouls === undefined || ancientSouls === null) ancientSouls = 0;
    //Inputs
    let zoneOverride = 0;
    if (!test && !simulating) {
        let IEsucks = getInputs();
        ancientSouls = IEsucks[0];
        zoneOverride = IEsucks[1];
        if( ancientSouls==-1 ) return;
        this.reserve = $("#reserveAS").is(":checked");
    }
    
    var transcendentPower = (25 - 23 * Math.exp(-0.0003 * ancientSouls)) / 100;

    // Figure out goals for this transcendence
    this.newHze = Math.floor(zoneOverride||0);
    borbTarget = 0;
    if(this.newHze==0){
    if (ancientSouls == 0) {
        this.newHze = 300;
    } else if (ancientSouls < 100) {
        let a = ancientSouls + 42;
        this.newHze = (a / 5 - 6) * 51.8 * Math.log(1.25) / Math.log(1 + transcendentPower);
    } else if (ancientSouls < 10500) {
        this.newHze = (1 - Math.exp(-ancientSouls / 3900)) * 200000 + 4800;
    } else if (ancientSouls < 21000) {
        let x = 8000 + (10500 - ancientSouls) / 10500 * 4000;
        this.newHze = ancientSouls*10.32 + x*12;
    } else {
        let nonBorb = ancientSouls > 433000 ? 500 : 1000;
        let b = this.spendAS(1, ancientSouls - nonBorb);
        borbTarget = b * 5000;
        if (b > 1026) {
            this.newHze = 5.46e6;
        } else if (borbToZone[b]) {
            this.newHze = Math.max(borbTarget + 500, borbToZone[b]);
        } else {
            this.newHze = borbTarget + 500;
        }
    }}

    this.newHze = Math.floor(this.newHze);
    let newLogHeroSouls = Math.log10(1 + transcendentPower) * this.newHze / 5 + 6;

    // Ancient effects
    let ancientLevels = Math.floor(newLogHeroSouls / Math.log10(2) - 3 / Math.log10(2)) - 1;
    let kuma = -8 * (1 - Math.exp(-0.025 * ancientLevels));
    let atman = 75 * (1 - Math.exp(-0.013 * ancientLevels));
    let bubos = -5 * (1 - Math.exp(-0.002 * ancientLevels));
    let chronos = 30 * (1 - Math.exp(-0.034 * ancientLevels));
    let dora = 9900 * (1 - Math.exp(-0.002 * ancientLevels));

    // Unbuffed Stats
    let nerfs = Math.floor(this.newHze / 500);
    let unbuffedMonstersPerZone = Math.round10(10 + nerfs * 0.1, -2);
    let unbuffedTreasureChestChance = 1 - 0.99999999 * (1 - Math.exp(-0.006 * nerfs));
    let unbuffedBossHealth = 10 + nerfs * 0.4;
    let unbuffedBossTimer = 30 - nerfs * 2;
    let unbuffedPrimalBossChance = 25 - nerfs * 2;

    // Outsider Caps
    let borbCap = borbTarget
        ? Math.ceil((borbTarget - 500) / 5000)
        : ancientSouls >= 10500
            ? Math.ceil((this.newHze - 500) / 5000)
            : Math.max(0, Math.ceil(((unbuffedMonstersPerZone - 2.1) / - kuma - 1) / 0.125));
    let rhageistCap = Math.ceil(((100 - unbuffedPrimalBossChance) / atman - 1) / 0.25);
    let kariquaCap = Math.ceil(((unbuffedBossHealth - 5) / -bubos - 1) / 0.5);
    let orphalasCap = Math.max(1, Math.ceil(((2 - unbuffedBossTimer) / chronos - 1) / 0.75)) + 2;
    let senakhanCap = Math.max(1, Math.ceil((100 / unbuffedTreasureChestChance) / (dora / 100 + 1) - 1));

    // Outsider Ratios
    let rhageistRatio;
    let kariquaRatio;
    let orphalasRatio;
    let senakhanRatio;

    if (ancientSouls < 100) {
        let ratioChange = ancientSouls / 100;
        rhageistRatio = 0.2*ratioChange;
        kariquaRatio = 0.01*ratioChange;
        orphalasRatio = 0.05*ratioChange;
        senakhanRatio = 0.05*ratioChange;
    } else if (ancientSouls < 21000) {
        rhageistRatio = 0.2;
        kariquaRatio = 0.01;
        orphalasRatio = 0.05;
        senakhanRatio = 0.05;
    } else {
        rhageistRatio = 0;
        kariquaRatio = 0;
        orphalasRatio = 0;
        senakhanRatio = 0;
    }
    
    if(!$("#levelOrphalas").is(":checked")) {
        orphalasRatio = 0;
    }

    // Outsider Leveling
    this.remainingAncientSouls = ancientSouls;
    
    let borbFantR = getBorbFant(ancientSouls, transcendentPower);
    let borbFant = ancientSouls <= 2000
        ? Math.min(this.spendAS(0.35, this.remainingAncientSouls), borbFantR)
        : 0;
    let borbHze = this.remainingAncientSouls >= 21000
        ? borbCap
        : Math.min(this.spendAS(ancientSouls >= 50 ? 0.99 : 0.5, this.remainingAncientSouls), borbCap + 1);
    let borbLevel = Math.max(borbFant, borbHze);

    if (this.getCostFromLevel(borbLevel) > (this.remainingAncientSouls - 5)) {
        borbLevel = this.spendAS(1, this.remainingAncientSouls - 5);
    }

    this.remainingAncientSouls -= this.getCostFromLevel(borbLevel);
    
    // Xyl sucks
    let xyliqilLevel = 0;
    this.remainingAncientSouls -= this.getCostFromLevel(xyliqilLevel);

    // Remove souls if using Reserve AS
    if (!test && this.reserve) {
        var unspentAncientSouls = Math.floor( this.remainingAncientSouls*0.1 )
        this.remainingAncientSouls -= unspentAncientSouls;
    }

    // Super outsiders
    let rhageistLevel = this.getCostFromLevel(rhageistCap) > (this.remainingAncientSouls * rhageistRatio)
        ? this.spendAS(rhageistRatio, this.remainingAncientSouls)
        : rhageistCap;
    let kariquaLevel = this.getCostFromLevel(kariquaCap) > (this.remainingAncientSouls * kariquaRatio)
        ? this.spendAS(kariquaRatio, this.remainingAncientSouls)
        : kariquaCap;
    let orphalasLevel = this.getCostFromLevel(orphalasCap) > (this.remainingAncientSouls * orphalasRatio)
        ? this.spendAS(orphalasRatio, this.remainingAncientSouls)
        : orphalasCap;
    let senakhanLevel = this.getCostFromLevel(senakhanCap) > (this.remainingAncientSouls * senakhanRatio)
        ? this.spendAS(senakhanRatio, this.remainingAncientSouls)
        : senakhanCap;

    this.remainingAncientSouls -= this.getCostFromLevel(rhageistLevel);
    this.remainingAncientSouls -= this.getCostFromLevel(kariquaLevel);
    this.remainingAncientSouls -= this.getCostFromLevel(orphalasLevel);
    this.remainingAncientSouls -= this.getCostFromLevel(senakhanLevel);

    // Chor, Phan, and Pony
    let IEsucks = this.nOS(this.remainingAncientSouls, transcendentPower, this.newHze);
    let chorLevel = IEsucks[0];
    let phanLevel = IEsucks[1];
    let ponyLevel = IEsucks[2];

    this.remainingAncientSouls -= this.getCostFromLevel(chorLevel);
    this.remainingAncientSouls -= phanLevel;
    this.remainingAncientSouls -= this.getCostFromLevel(ponyLevel);

    // End of transcension estimates
    let ponyBonus = Math.pow(ponyLevel, 2) * 10;
    let series = 1 / (1 - 1 / (1 + transcendentPower));
    let buffedPrimalBossChance = Math.max(5, unbuffedPrimalBossChance + atman * (1 + rhageistLevel * 0.25));
    let pbcm = Math.min(buffedPrimalBossChance, 100) / 100;

    newLogHeroSouls = Math.log10(1 + transcendentPower) * (this.newHze - 100) / 5 + Math.log10(ponyBonus + 1) + Math.log10(20 * series * pbcm);
    this.newAncientSouls = Math.max(ancientSouls, Math.floor(newLogHeroSouls * 5));
    this.ancientSoulsDiff = this.newAncientSouls - ancientSouls;
    this.newTranscendentPower = (25 - 23 * Math.exp(-0.0003 * this.newAncientSouls)) / 100;

    //test log
    var unspent = this.remainingAncientSouls + (unspentAncientSouls||0);
    if (test) {
        return (JSON.stringify({
            ancientSouls: ancientSouls,
            expectedLevels: [xyliqilLevel,chorLevel,phanLevel,ponyLevel,borbLevel,rhageistLevel,kariquaLevel,orphalasLevel,senakhanLevel],
            expectedRemaining: unspent,
            newHze: this.newHze,
            newLogHeroSouls: newLogHeroSouls,
            newAncientSouls: this.newAncientSouls,
            newTranscendentPower: this.newTranscendentPower*100
        }));
    }
    
    //transcensionSimulator
    var buffedMPZ = unbuffedMonstersPerZone + kuma*( 1 + borbLevel/8 );
    if (simulating) return [ancientSouls, borbLevel, this.newHze, buffedMPZ, this.newAncientSouls];

    // Display the results
    $("#TP").html("超越之力: " + tpDisplay(ancientSouls));
    //End of Transcension
    $("#predictedHZE").html("有史以来最高的层: " + this.newHze.toLocaleString() );
    $("#predictedHS").html("英魂的数量级: " + newLogHeroSouls.toFixed(2).toLocaleString() );
    $("#predictedAS").html("远古之魂: " + this.newAncientSouls.toLocaleString() + " (+" + this.ancientSoulsDiff.toLocaleString() + ")");
    $("#predictedTP").html("超越之力: " + tpDisplay(this.newAncientSouls));
    $("#predictedAncients").html("Ancient Levels: " + ancientLevels.toLocaleString() );
    $("#kuma").html( kuma.toFixed(2) + " 怪/层" );
    $("#atman").html( atman.toFixed(2) + "% 初始机会" );
    $("#bubos").html( bubos.toFixed(2) + " boss生命" );
    $("#chronos").html( chronos.toFixed(2) + "s boss战斗时长" );
    $("#dora").html( dora.toFixed(2) + "% 宝箱" );

    const showStatsAtHZE = $("#statsHZE").is(":checked");
    if (showStatsAtHZE) {
        //Unbuffed Stats
        $("#unbuffedMPZ").html( " 怪/层" + unbuffedMonstersPerZone.toFixed(2) );
        $("#unbuffedTCC").html( "宝箱: " + unbuffedTreasureChestChance.toFixed(6) + "x" );
        $("#unbuffedBossHP").html( "boss生命: " + unbuffedBossHealth.toFixed(1) + "x" );
        $("#unbuffedTimer").html( "Boss战斗时长: " + unbuffedBossTimer + "s" );
        $("#unbuffedPBC").html( "初始机会: " + unbuffedPrimalBossChance + "%" );
        //Buffed Stats
        var buffedTCC = Math.max( 1, ( dora*( 1 + senakhanLevel)/100 + 1 )*unbuffedTreasureChestChance );
            buffedBossHP = Math.floor( Math.max( 5, unbuffedBossHealth + bubos*( 1 + kariquaLevel*0.5 ) ) );
            buffedTimer = Math.max( 2, unbuffedBossTimer + chronos*( 1 + orphalasLevel*0.75 ) );
            buffedPBC = Math.max( 5, unbuffedPrimalBossChance + atman*( 1 + rhageistLevel*0.25 ) );
        $("#buffedMPZ").html( " 怪/层" + buffedMPZ.toFixed(2) + (buffedMPZ<2?" (2)":"") );
        $("#buffedTCC").html( "宝箱: " + buffedTCC.toFixed() + "%" );
        $("#buffedBossHP").html( "boss生命: " + buffedBossHP.toFixed() + "x" );
        $("#buffedTimer").html( "Boss战斗时长: " + buffedTimer.toFixed() + "s" );
        $("#buffedPBC").html( "初始机会: " + buffedPBC.toFixed() + "%" );
        $("#unbuffedHZE").show();
        $("#buffedHZE").show();
    } else {
        $("#unbuffedHZE").hide();
        $("#buffedHZE").hide();
    }
    //Zone Breakpoints
    $("#HighMpz").html( "2.1 怪每秒: " + ( -39500 - Math.floor( kuma*( 1 + borbLevel/8 )*10 )*500 ).toLocaleString() );
    $("#5PBC").html( "5% 初始机会: " + ( 5500 + Math.floor( atman*( 1 + rhageistLevel/4 )/2)*500 ).toLocaleString() );
    $("#90BHP").html( "90% boss生命: " + ( Math.ceil( ( bubos*( 1 + kariquaLevel/2 )*-10 - 10 )/0.4 )*500 ).toLocaleString() );
    $("#2sTimer").html( "2s boss战斗时长: " + ( 7000 + Math.floor( chronos*( 1 + orphalasLevel*0.75 )/2 )*500 ).toLocaleString() );
    $("#99TTC").html( "99% 宝箱 " + (Math.ceil( Math.log( 0.995/( dora/10000*( 1 + senakhanLevel ) + 0.01 ) )/-0.006 )*500 ).toLocaleString() );
    $("#1TTC").html( "1% 宝箱: " + (Math.ceil( Math.log( 0.015/( dora/10000*( 1 + senakhanLevel ) + 0.01 ) )/-0.006 )*500 ).toLocaleString() );
    $("#estimates").show();

    //Outsiders Table
    $("#OutsidersTable tbody").html(
        "<tr><td>犀利契</td><td>"+xyliqilLevel.toLocaleString()+"</td><td>"+getCostFromLevel(xyliqilLevel).toLocaleString()+"</td><tr>"+
        "<tr><td>楚格洛斯</td><td>"+chorLevel.toLocaleString()+"</td><td>"+getCostFromLevel(chorLevel).toLocaleString()+"</td><tr>"+
        "<tr><td>樊德瑞斯</td><td>"+phanLevel.toLocaleString()+"</td><td>"+phanLevel.toLocaleString()+"</td><tr>"+
        "<tr><td>马夫</td><td>"+ponyLevel.toLocaleString()+"</td><td>"+getCostFromLevel(ponyLevel).toLocaleString()+"</td><tr>"+
        "<tr><td>波尔</td><td>"+borbLevel.toLocaleString()+"</td><td>"+getCostFromLevel(borbLevel).toLocaleString()+"</td><tr>"+
        "<tr><td>Rhageist</td><td>"+rhageistLevel.toLocaleString()+"</td><td>"+getCostFromLevel(rhageistLevel).toLocaleString()+"</td><tr>"+
        "<tr><td>K'Ariqua</td><td>"+kariquaLevel.toLocaleString()+"</td><td>"+getCostFromLevel(kariquaLevel).toLocaleString()+"</td><tr>"+
        "<tr><td>Orphalas</td><td>"+orphalasLevel.toLocaleString()+"</td><td>"+getCostFromLevel(orphalasLevel).toLocaleString()+"</td><tr>"+
        "<tr><td>Sen-Akhan</td><td>"+senakhanLevel.toLocaleString()+"</td><td>"+getCostFromLevel(senakhanLevel).toLocaleString()+"</td><tr>"
    );
    $("#share").html(
        xyliqilLevel+'/'+
        chorLevel+'/'+
        phanLevel+'/'+
        ponyLevel+'//'+
        borbLevel+'/'+
        rhageistLevel+'/'+
        kariquaLevel+'/'+
        orphalasLevel+'/'+
        senakhanLevel
    );
    $("#unspentAS").html( "未使用: " + unspent );
    $("#results").show();
    
    if (!$("#helpText").is(":checked")) {
        $('#checkResults').parent().hide();
    } else {
        let infoMessage = "";
        if (ancientSouls === 0) {
            infoMessage += "<li>你需要有远古之魂才能发挥作用。 在 300 层解锁超越后立即超越。这是值得的。</li>";
        } else {
            if(ancientSouls < 2000) {
                infoMessage += "<li>你的第一次转生应该在 130 层，这样你就可以尽快解锁 熊若丸 和其他一些神器。 这会大大加快你的转生。</li>"
                if (borbHze < borbLevel && ancientSouls > 50) {
                    infoMessage += "<li>在你的最后一次转生中，每个层只需要 " + borbHze + " 波尔有2个怪物，但在130层首次转生后，每个层需要 " + borbFantR
                    + " 波尔2个怪物。</li>";
                    infoMessage += "<li>有比上一次更多的转生。波尔被调平得更高，以加快早期转生的速度。</li>"
                }
            }
            if (ancientSouls < 10500) {
                infoMessage += "<li>在获得<b>新</b>的远古之魂的3或4次转生之后超越。转生需要为你赢得比你之前超越更多的英魂才能计数。</li>";
                infoMessage += "<li>下面的最高层是一个估计值，假设你玩得很活跃，只要你有两个自动点击，你就应该这么做。</li>"
            } else {
                if (ancientSouls < 27000) {
                    infoMessage += "<li>注意“给予远古英魂的3或4次转生”的指南<b>不适用于超过24%的超越之力！</b></li>";
                    infoMessage += "<li>继续转生，直到你至少到达下面显示的估计最高层。这将花费比你习惯的更长的时间（更多的转生）。</li>";
                    infoMessage += "<li>你正在接近25%的超越之力，因此超越不会像以前那样给你带来太大的提升。</li>"
                }
                if (ancientSouls >= 21000) {
                    if (ancientSouls < 50000) {
                        infoMessage += "<li>你有足够的超越之力到达任何英雄。你只波尔等级的限制。你只会超越，给波尔更多的等级。</li>";
                        infoMessage += "<li>最后 4 个超越者不切实际/不可能在高层维护，因此它们保持在 0。 <b>这不是bug!</b></li>";
                    }
                    if (this.newHze < 5.37e6 && buffedMPZ > 10) {
                        infoMessage += "<li>如果您想要更愉快的跑步，您可以比最高层估计所需的转生少一次。从长远来看，它只会比最佳状态差一点。</li>"
                    }
                }
            }
        }
        if (infoMessage !== "") {
            $('#checkResults').html("<ul>"+infoMessage+"</ul>");
            $('#checkResults').parent().show();
        } else {
            $('#checkResults').parent().hide();
        }
    }

    const simulatorEnabled = $("#simulator").is(":checked");
    if (simulatorEnabled) {
        updateTable(ancientSouls, borbLevel, this.newHze, buffedMPZ, this.newAncientSouls, zoneOverride>0?true:false);
        $('#simulatorBox').show();
    } else {
        $('#simulatorBox').hide();
    }
    
    $("#outputsave").html("");

    const autolevelEnabled = $("#autolevel").is(":checked");
    if (autolevelEnabled) {
        return [xyliqilLevel, chorLevel, phanLevel, ponyLevel, borbLevel, rhageistLevel, kariquaLevel, orphalasLevel, senakhanLevel, unspent];
    }
}

function tpDisplay(ancientSouls) {
    if (ancientSouls >= 124767) {
        return "25%"
    }
    let tp = (25 - 23 * Math.exp(-0.0003 * ancientSouls));
    if (tp === 25) {
        return "24.9999%"
    }
    return tp.toString().substring(0,tp<10?6:7) + "%";
}

function test() {
    var cases = [0,1,10,100,500,1000,5000,10000,12500,15000,17500,20000,50000,100000,200000,300000,400000,500000];
        readout = "[\n";
    for (i=0;i<cases.length;i++) {
        readout += "    " + refresh(true,cases[i]) + ",\n";
    }
    readout = readout.slice(0, -2);
    readout += "\n]";
    console.log(readout);
}

function enterKey(ev) {
    if (ev.which === 13) {
        clearOutput();
        refresh();
    }
}

$("#ancient_souls").keyup(enterKey);
$("#zoneOverride").keyup(enterKey);

function changeTheme() {
    if ($("#dark").is(":checked")) {
        $("#theme-light").prop("disabled", true);
        $("#theme-dark").prop("disabled", false);
    } else {
        $("#theme-light").prop("disabled", false);
        $("#theme-dark").prop("disabled", true);
    }
    if (localStorage) localStorage.setItem("darkmode", $("#dark").is(":checked"));
}

function toggleHelpText() {
    if (localStorage) localStorage.setItem("helpText", $("#helpText").is(":checked"));
}

function toggleSetting(settingName) {
    if (localStorage) localStorage.setItem(settingName, $(`#${settingName}`).is(":checked"));
}

$(setDefaults);


$(function() {
    if (localStorage) {
        $("#dark").prop("checked", localStorage.getItem("darkmode")!=="false");
        // default false
        ["autolevel", "levelOrphalas", "reserveAS", "statsHZE"]
            .forEach(
                (settingName) => $(`#${settingName}`).prop("checked", localStorage.getItem(settingName)==="true")
            );
        // default true
        ["simulator", "helpText"]
            .forEach(
                (settingName) => $(`#${settingName}`).prop("checked", localStorage.getItem(settingName)!=="false")
            );
    }
    $('.collapsible .title').click(function(){
        $(this).parent().find('.content').toggle();
    });

    $('.numberInput p').click(function(){
        $(this).parent().find('input').focus();
    });
});